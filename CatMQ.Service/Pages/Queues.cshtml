@page
@using NTDLS.Helpers
@model QueuesModel
@{
    ViewData["Title"] = "Queues";
}

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            await refreshQueues();
            setInterval(refreshQueues, 5000);
        });


        async function refreshQueues() {
            try {
                const url = `?handler=Queues`;
                const response = await fetch(url, {
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) {
                    console.error('Failed to load subscribers. HTTP', response.status);
                    return;
                }

                const data = await response.json();
                renderQueues(data);
            } catch (err) {
                console.error('Error loading subscribers:', err);
            }
        }

        function buildRow(queue) {
            return `
                <tr>
                    <td><a href="/queue/${queue.queueName}">${queue.queueName}</a></td>
                    <td class="text-end">${queue.currentSubscriberCount}</td>
                    <td class="text-end"><a href="/messages/${queue.queueName}">${queue.queueDepth}</a></td>
                    <td class="text-end">${queue.currentOutstandingDeliveries}</td>
                    <td class="text-end">${queue.receivedMessageCount}</td>
                    <td class="text-end">${queue.deliveredMessageCount}</td>
                    <td class="text-end">${queue.expiredMessageCount}</td>
                    <td class="text-end">${queue.failedDeliveryCount}</td>
                </tr>`;
        }

        function renderQueues(subscribers) {
            const tbody = document.getElementById('queues-body');
            if (!tbody) return;

            if (!Array.isArray(subscribers) || subscribers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No queues.
                        </td>
                    </tr>`;
                return;
            }

            const rowsHtml = subscribers.map(buildRow).join('');
            tbody.innerHTML = rowsHtml;
        }

    </script>
    <script src="~/js/queueChart.js"></script>
}

<div>
    <div class="container mt-4">
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th colspan="8">Queues</th>
                </tr>
            </thead>
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Subscribers</th>
                    <th>Depth</th>
                    <th>Outstanding</th>
                    <th>Received</th>
                    <th>Delivered</th>
                    <th>Expired</th>
                    <th>Failures</th>
                </tr>
            </thead>

            <tbody id="queues-body">
                <!-- Filled by JS -->
            </tbody>
        </table>
    </div>
</div>
