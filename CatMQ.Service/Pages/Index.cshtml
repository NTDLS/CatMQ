@page
@using NTDLS.Helpers
@model IndexModel
@{
    ViewData["Title"] = "Home";
}

@section Scripts {
    <script>

        window.chartDataUrl = '@Url.Page(null, "ChartData")';

        document.addEventListener("DOMContentLoaded", async function () {
            await refreshQueues();
            setInterval(refreshQueues, 5000);
        });

        async function refreshQueues() {
            try {
                const url = `?handler=Queues`;
                const response = await fetch(url, {
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) {
                    console.error('Failed to load subscribers. HTTP', response.status);
                    return;
                }

                const data = await response.json();
                renderQueues(data.queues);

                document.getElementById('q-currentSubscriberCount').textContent = data.totals.currentSubscriberCount;
                document.getElementById('q-queueDepth').textContent = data.totals.queueDepth;
                document.getElementById('q-currentOutstandingDeliveries').textContent = data.totals.currentOutstandingDeliveries;
                document.getElementById('q-receivedMessageCount').textContent = data.totals.receivedMessageCount;
                document.getElementById('q-deliveredMessageCount').textContent = data.totals.deliveredMessageCount;
                document.getElementById('q-deferredDeliveryCount').textContent = data.totals.deferredDeliveryCount;
                document.getElementById('q-expiredMessageCount').textContent = data.totals.expiredMessageCount;
                document.getElementById('q-failedDeliveryCount').textContent = data.totals.failedDeliveryCount;
            } catch (err) {
                console.error('Error loading subscribers:', err);
            }
        }

        function buildRow(queue) {
            return `
                <tr>
                    <td><a href="/queue/${queue.queueName}">${queue.queueName}</a></td>
                    <td class="text-end">${queue.currentSubscriberCount}</td>
                    <td class="text-end"><a href="/messages/${queue.queueName}">${queue.queueDepth}</a></td>
                    <td class="text-end">${queue.receivedMessageCount}</td>
                    <td class="text-end">${queue.deliveredMessageCount}</td>
                    <td class="text-end">${queue.deferredDeliveryCount}</td>
                    <td class="text-end">${queue.expiredMessageCount}</td>
                    <td class="text-end">${queue.failedDeliveryCount}</td>
                </tr>`;
        }

        function renderQueues(subscribers) {
            const tbody = document.getElementById('queues-body');
            if (!tbody) return;

            if (!Array.isArray(subscribers) || subscribers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No queues.
                        </td>
                    </tr>`;
                return;
            }

            const rowsHtml = subscribers.map(buildRow).join('');
            tbody.innerHTML = rowsHtml;
        }

    </script>
    <script src="~/js/queueChart.js"></script>
}

<div>
    <a href="http://NetworkDLS.com/">NetworkDLS</a> <a href="https://github.com/NTDLS/CatMQ">CatMQ</a> version @Model.ApplicationVersion<br />

    <div class="card shadow-lg mt-2">
        <div class="card-header">
            <h5>Service Configuration</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped table-bordered">
                <thead class="table-light">
                    <tr>
                        <th class="text-end">Listen Port</th>
                        <th class="text-end">Ack. Timeout</th>
                        <th class="text-end">Initial Buffer</th>
                        <th class="text-end">Max. Buffer</th>
                        <th class="text-end">Buffer Growth Rate</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-end">@Model.ServerConfig.ListenPort</td>
                        <td class="text-end">@Model.ServerConfig.AcknowledgmentTimeoutSeconds.ToString("n0")</td>
                        <td class="text-end">@Formatters.FileSize(Model.ServerConfig.InitialReceiveBufferSize, 2)</td>
                        <td class="text-end">@Formatters.FileSize(Model.ServerConfig.MaxReceiveBufferSize, 1)</td>
                        <td class="text-end">@((Model.ServerConfig.ReceiveBufferGrowthRate * 100).ToString("n0"))%</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card shadow-lg mt-2">
        <div class="card-header">
            <h5>Statistics</h5>
        </div>
        <div class="card-body">
            <canvas id="queueChart" height="50"></canvas>
              <table class="table table-striped table-bordered mt-1">
                <thead class="table-light">
                    <tr>
                        <th class="text-end">Subscribers</th>
                        <th class="text-end">Depth</th>
                        <th class="text-end">Outstanding</th>
                        <th class="text-end">Received</th>
                        <th class="text-end">Delivered</th>
                        <th class="text-end">Deferred</th>
                        <th class="text-end">Expired</th>
                        <th class="text-end">Failures</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-end" id="q-currentSubscriberCount">...</td>
                        <td class="text-end" id="q-queueDepth">...</></td>
                        <td class="text-end" id="q-currentOutstandingDeliveries">...</td>
                        <td class="text-end" id="q-receivedMessageCount">...</td>
                        <td class="text-end" id="q-deliveredMessageCount">...</td>
                        <td class="text-end" id="q-deferredDeliveryCount">...</td>
                        <td class="text-end" id="q-expiredMessageCount">...</td>
                        <td class="text-end" id="q-failedDeliveryCount">...</td>
                    </tr>
                </tbody>
            </table> 
        </div>
    </div>

    <div class="card shadow-lg mt-2">
        <div class="card-header">
            <h5>Queues</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th class="text-end">Subscribers</th>
                        <th class="text-end">Depth</th>
                        <th class="text-end">Received</th>
                        <th class="text-end">Delivered</th>
                        <th class="text-end">Deferred</th>
                        <th class="text-end">Expired</th>
                        <th class="text-end">Failures</th>
                    </tr>
                </thead>
                <tbody id="queues-body">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>
