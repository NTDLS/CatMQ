@page "/account/{AccountId}"
@using NTDLS.Helpers
@model AccountModel
@{
    ViewData["Title"] = "Account";
}
@section Scripts {
    <script>
        async function onDeleteAccount(accountId, username) {
            const url = `/ui/DeleteAccount/${accountId}`;
            const message = `Deleting account ${username}' will also remove any associated API keys. Continue?`;

            const ok = await showConfirmModal(message);
            if (!ok) return;

            try {
                const response = await fetch(url, {
                    method: "POST",
                    credentials: 'same-origin',
                    headers: {
                        "Accept": "application/json",
                    }
                });

                if (!response.ok) {
                    alert("Operation failed.");
                    return;
                }

                window.location.href = "/Accounts";
            }
            catch (error) {
                alert(`Operation failed: ${error}`);
            }
        }

        async function onDeleteAPIKey(accountId, apiKeyId) {
            const url = `/ui/DeleteAPIKey/${accountId}/${apiKeyId}`;
            const message = `Deleting API key '${apiKeyId}' is not reversable. Continue?`;

            const ok = await showConfirmModal(message);
            if (!ok) return;

            try {
                const response = await fetch(url, {
                    method: "POST",
                    credentials: 'same-origin',
                    headers: {
                        "Accept": "application/json",
                    }
                });

                if (!response.ok) {
                    alert("Operation failed.");
                    return;
                }

                window.location.href = "/Account/@Model.AccountId";
            }
            catch (error) {
                alert(`Operation failed: ${error}`);
            }
        }
    </script>
 }

<div>
    <form method="post" asp-page-handler="SaveAccount">
        <div class="card shadow-lg">
            <div class="card-header">
                <h5>Account</h5>
            </div>
            <div class="card-body">

                <div class="mb-3">
                    <label for="username" class="form-label fw-bold">Username</label>
                    <span asp-validation-for="Account.Username" class="text-danger"></span>
                    <input type="text" id="username" class="form-control" asp-for="Account.Username">
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label fw-bold">Description</label>
                    <span asp-validation-for="Account.Description" class="text-danger"></span>
                    <input type="text" id="description" class="form-control" asp-for="Account.Description">
                </div>

                <div class="mb-3">
                    <label for="timeZone" class="form-label fw-bold">Time Zone</label>
                    <span asp-validation-for="Account.TimeZone" class="text-danger"></span>
                    <select id="timeZone" class="form-select" asp-for="Account.TimeZone" asp-items="@(new SelectList(Model.TimeZones, "Value", "Text"))">
                        <option value="">Select a time zone</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label fw-bold">Change Password</label>
                    <span asp-validation-for="Password" class="text-danger"></span>
                    <input type="text" id="password" class="form-control" asp-for="Password" autocomplete="new-password-no-auto-fill">
                </div>

                <button type="submit" class="btn btn-primary">Save</button>

                <a class="btn btn-danger" href="javascript:void(0)" onclick="onDeleteAccount('@Model.AccountId', '@Model.Account.Username')">Delete</a>
            </div>
        </div>
        <br />
    </form>

    <form method="post" asp-page-handler="CreateAPIKey">
        <div class="card shadow-lg">
            <div class="card-header">
                <h5>API Keys</h5>
            </div>
            <div class="card-body">
                @if (Model.Account.ApiKeys.Count > 0)
                {
                    <table class="table table-striped table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Key</th>
                                <th>Description</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var apiKey in Model.Account.ApiKeys)
                            {
                                <tr>
                                    <td>
                                        <a href="/ApiKey/@Model.AccountId/@apiKey.Id">@apiKey.Key</a>
                                    </td>
                                    <td>
                                        @apiKey.Description
                                    </td>
                                    <td>
                                        <a class="btn btn-danger btn-thin" href="javascript:void(0)" onclick="onDeleteAPIKey('@Model.AccountId', '@apiKey.Id')">Delete</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                <button type="submit" class="btn btn-primary">Create API Key</button>
            </div>
        </div>
    </form>
</div>
